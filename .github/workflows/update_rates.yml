name: Update Exchange Rates

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-rates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Exchange Rates
        run: |
          # Fetch USD base rates from ExchangeRate-API
          curl -s "https://open.er-api.com/v6/latest/USD" -o rates.json

          # Verify JSON validity
          if ! jq -e . >/dev/null 2>&1 < rates.json; then
            echo "Error: Invalid JSON received"
            exit 1
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Check if rates.json has changed
          if git diff --quiet rates.json; then
            echo "No changes in exchange rates"
            exit 0
          fi

          git add rates.json
          git commit -m "chore: update exchange rates [skip ci]"
          git push
